<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Clubs de tir à l'arc – Pays de la Loire</title>

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        crossorigin=""
    />

    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f4f4f4;
            color: #222;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            margin-top: 16px;
            font-size: 1.6rem;
            text-align: center;
        }

        #controls {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        #controls input,
        #controls select {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 0.9rem;
        }

        #controls button {
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
            background: #3b82f6;
            color: #fff;
            font-size: 0.9rem;
            cursor: pointer;
        }

        #controls button:hover {
            background: #2563eb;
        }

        #map-container {
            margin: 12px auto 24px;
            max-width: 1000px;
            width: 100%;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 12px;
        }

        #map {
            width: 100%;
            height: 650px;
            border-radius: 10px;
        }

        .club-popup h2 {
            margin: 0 0 4px;
            font-size: 1.05rem;
        }

        .club-popup p {
            margin: 2px 0;
            font-size: 0.85rem;
        }

        .club-popup h3 {
            margin: 8px 0 4px;
            font-size: 0.9rem;
        }

        .club-popup table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 4px;
        }

        .club-popup th,
        .club-popup td {
            padding: 3px 4px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.8rem;
            text-align: left;
        }

        .club-popup th {
            font-weight: 600;
        }

        .club-popup .no-data {
            font-style: italic;
            color: #6b7280;
            margin-top: 6px;
        }

        .leaflet-popup-content {
            margin: 6px 8px;
        }

        .legend {
            background: white;
            padding: 6px 8px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            font-size: 0.8rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 3px;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
    </style>
</head>
<body>

<h1>Clubs de tir à l'arc – Pays de la Loire<br><small>Les entraineurs de la région</small></h1>

<div id="controls">
    <input id="search-club" type="text" placeholder="Recherche club / ville..." />
    <select id="filter-dept">
        <option value="">Tous départements</option>
    </select>
    <select id="filter-diplome">
        <option value="">Tous diplômes</option>
        <option value="assistant_entraineur">Assistant Entraineur</option>
        <option value="entraineur_club">Entraineur de club</option>
        <option value="initiateur">Initiateur</option>
        <option value="encadrant_federal">Encadrant fédéral</option>
        <option value="entraineur_1">Entraineur 1</option>
        <option value="entraineur_2">Entraineur 2</option>
        <option value="entraineur_federal">Entraineur fédéral</option>
        <option value="bees">BEES 1 / 2</option>
        <option value="dejeps">DEJEPS</option>
    </select>
    <button id="btn-reset">Réinitialiser</button>
</div>

<div id="map-container">
    <div id="map"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// --------------------------------------------------
// Utils texte
// --------------------------------------------------
function normalize(str) {
    return (str || "")
        .toString()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "") // supprime accents
        .toLowerCase();
}

// Nettoyage des textes pour corriger les artefacts d'encodage (FÃ©dÃ©ral -> Fédéral)
function cleanText(raw) {
    if (!raw) return "";
    let s = raw.toString().trim();

    const fixes = {
        "Ã©": "é",
        "Ã¨": "è",
        "Ãª": "ê",
        "Ã«": "ë",
        "Ã ": "à",
        "Ã¢": "â",
        "Ã¹": "ù",
        "Ãº": "ú",
        "Ã»": "û",
        "Ã´": "ô",
        "Ã¶": "ö",
        "Ã¯": "ï",
        "Ã®": "î",
        "Ã§": "ç",
        "Ã‰": "É",
        "Ã€": "À",
        "Ã‚": "Â",
        "Ãœ": "Ü",
        "â": "’",
        "â": "–",
        "â¢": "•"
    };

    for (const bad in fixes) {
        const good = fixes[bad];
        s = s.replace(new RegExp(bad, "g"), good);
    }

    // supprime les Â parasites laissés
    s = s.replace(/Â/g, "");

    return s;
}

// alias pour diplômes (même nettoyage)
function cleanDiplome(raw) {
    return cleanText(raw);
}

// --------------------------------------------------
// Lecture CSV encodé Windows-1252
// --------------------------------------------------
async function loadCSV(path) {
    const resp = await fetch(path);
    const buffer = await resp.arrayBuffer();
    const decoder = new TextDecoder("windows-1252");
    const text = decoder.decode(buffer);
    return text.split(/\r?\n/).filter(l => l.trim() !== "");
}

// --------------------------------------------------
// Coordonnées GPS format "47,3278 N"
// --------------------------------------------------
function parseLatLon(latLike, lonLike) {
    if (!latLike || !lonLike) return null;

    let latStr = latLike.replace(",", ".");
    let lonStr = lonLike.replace(",", ".");

    let lat = parseFloat(latStr);
    let lon = parseFloat(lonStr);

    if (latStr.toUpperCase().includes("S")) lat = -lat;
    if (lonStr.toUpperCase().includes("O") || lonStr.toUpperCase().includes("W")) lon = -lon;

    return { lat, lon };
}

// --------------------------------------------------
// Département à partir du Code Structure (12 + code dép + ...)
// --------------------------------------------------
function inferDepartement(codeStructure) {
    if (!codeStructure || codeStructure.length < 4) return "";
    const deptNum = codeStructure.substring(2, 4);

    const mapping = {
        "44": "Loire-Atlantique",
        "49": "Maine-et-Loire",
        "53": "Mayenne",
        "72": "Sarthe",
        "85": "Vendée"
    };

    return mapping[deptNum] || "";
}

// --------------------------------------------------
// Classement des diplômes selon ta hiérarchie
// Assistant < Entraineur de club < Initiateur
// < Encadrant fédéral < Entraineur 1 < Entraineur 2
// < Entraineur fédéral < BEES 1 < BEES 2 < DEJEPS
// --------------------------------------------------
function classifyDiplome(diplome) {
    const d = normalize(diplome);

    if (!d) return { key: "AUTRE", rank: 1, label: diplome || "Autre" };

    if (d.includes("dejeps"))              return { key: "DEJEPS", rank: 10, label: diplome };
    if (d.includes("bees 2"))              return { key: "BEES",   rank: 9,  label: diplome };
    if (d.includes("bees 1") || d.startsWith("bees"))
                                           return { key: "BEES",   rank: 8,  label: diplome };
    if (d.includes("entraineur federal"))  return { key: "EFED",   rank: 7,  label: diplome };
    if (d.includes("entraineur 2"))        return { key: "E2",     rank: 6,  label: diplome };
    if (d.includes("entraineur 1"))        return { key: "E1",     rank: 5,  label: diplome };
    if (d.includes("encadrant") && d.includes("federal"))
                                           return { key: "ENCAD",  rank: 4,  label: diplome };
    if (d.includes("initiateur"))          return { key: "INIT",   rank: 3,  label: diplome };
    if (d.includes("entraineur de club"))  return { key: "CLUB",   rank: 2,  label: diplome };
    if (d.includes("assistant entraineur"))return { key: "ASSIST", rank: 1.5,label: diplome };

    return { key: "AUTRE", rank: 1, label: diplome || "Autre" };
}

function computeClubLevel(club) {
    if (!club.coachs.length) {
        return { key: "NOC", rank: 0, label: "Sans entraîneur" };
    }
    let best = { key: "AUTRE", rank: 1, label: "Autre" };
    for (const c of club.coachs) {
        const info = classifyDiplome(c.diplome);
        if (info.rank > best.rank) best = info;
    }
    return best;
}

// --------------------------------------------------
// Couleurs par niveau
// --------------------------------------------------
const levelColors = {
    DEJEPS: "#7c3aed", // violet
    BEES:   "#0d9488", // teal
    EFED:   "#b91c1c", // rouge foncé (Entraineur fédéral)
    E2:     "#ea580c", // orange foncé
    E1:     "#f97316", // orange
    ENCAD:  "#ef4444", // rouge (Encadrant fédéral)
    INIT:   "#3b82f6", // bleu
    CLUB:   "#22c55e", // vert (Entraineur de club)
    ASSIST: "#a3e635", // vert clair (Assistant)
    AUTRE:  "#6b7280", // gris moyen
    NOC:    "#9ca3af"  // gris clair (sans entraîneur)
};

// --------------------------------------------------
// Carte Leaflet
// --------------------------------------------------
const map = L.map("map").setView([47.5, -0.7], 8);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18
}).addTo(map);

const markers = [];
const searchInput   = document.getElementById("search-club");
const filterDept    = document.getElementById("filter-dept");
const filterDiplome = document.getElementById("filter-diplome");
const btnReset      = document.getElementById("btn-reset");

// --------------------------------------------------
// Filtre diplômes (menu déroulant)
// --------------------------------------------------
function diplomeMatchClub(club, filterKey) {
    if (!filterKey) return true;

    const dNorms = (club.diplomes || []).map(d => normalize(d));

    switch (filterKey) {
        case "assistant_entraineur":
            return dNorms.some(d => d.includes("assistant entraineur"));
        case "entraineur_club":
            return dNorms.some(d => d.includes("entraineur de club"));
        case "initiateur":
            return dNorms.some(d => d.includes("initiateur"));
        case "encadrant_federal":
            return dNorms.some(d => d.includes("encadrant") && d.includes("federal"));
        case "entraineur_1":
            return dNorms.some(d => d.includes("entraineur 1"));
        case "entraineur_2":
            return dNorms.some(d => d.includes("entraineur 2"));
        case "entraineur_federal":
            return dNorms.some(d => d.includes("entraineur federal"));
        case "bees":
            return dNorms.some(d => d.startsWith("bees"));
        case "dejeps":
            return dNorms.some(d => d.includes("dejeps"));
        default:
            return true;
    }
}

// --------------------------------------------------
// Popup
// --------------------------------------------------
function buildPopupHtml(club) {
    let h = `<div class="club-popup">`;
    h += `<h2>${club.nom}</h2>`;
    if (club.nomCourt) {
        h += `<p><strong>${club.nomCourt}</strong></p>`;
    }
    if (club.departement) {
        h += `<p>Département : ${club.departement}</p>`;
    }
    if (club.level && club.level.key !== "NOC") {
        h += `<p>Niveau max : <strong>${club.level.label}</strong></p>`;
    } else {
        h += `<p><strong>Sans entraîneur renseigné</strong></p>`;
    }

    if (!club.coachs.length) {
        h += `<p class="no-data">Aucun entraîneur renseigné pour ce club.</p>`;
    } else {
        h += `<table><thead><tr>
            <th>Prénom</th><th>Nom</th><th>Diplôme</th>
        </tr></thead><tbody>`;
        for (const c of club.coachs) {
            h += `<tr><td>${c.prenom}</td><td>${c.nom}</td><td>${c.diplome}</td></tr>`;
        }
        h += `</tbody></table>`;
    }

    h += `</div>`;
    return h;
}

// --------------------------------------------------
// Markers + filtres
// --------------------------------------------------
function createCircleMarker(lat, lon, levelKey) {
    const color = levelColors[levelKey] || levelColors.AUTRE;
    return L.circleMarker([lat, lon], {
        radius: 7,
        color: "#ffffff",
        weight: 1,
        fillColor: color,
        fillOpacity: 1
    });
}

function applyFilters() {
    const search = normalize(searchInput.value);
    const deptVal = filterDept.value;
    const diplVal = filterDiplome.value;

    markers.forEach(({ marker, club }) => {
        const txt = normalize(club.nom + " " + club.nomCourt);
        const okSearch = !search || txt.includes(search);
        const okDept   = !deptVal || club.departement === deptVal;
        const okDipl   = diplomeMatchClub(club, diplVal);

        if (okSearch && okDept && okDipl) {
            marker.addTo(map);
        } else {
            map.removeLayer(marker);
        }
    });
}

function addLegend() {
    const legend = L.control({ position: "bottomleft" });
    legend.onAdd = function () {
        const div = L.DomUtil.create("div", "legend");
        div.innerHTML = `
            <div class="legend-item">
                <span class="legend-color" style="background:${levelColors.DEJEPS};"></span> DEJEPS
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background:${levelColors.BEES};"></span> BEES 1 / 2
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background:${levelColors.EFED};"></span> Entraineur fédéral
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background:${levelColors.E2};"></span> Entraineur 2
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background:${levelColors.E1};"></span> Entraineur 1
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background:${levelColors.ENCAD};"></span> Encadrant fédéral
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background:${levelColors.INIT};"></span> Initiateur
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background:${levelColors.CLUB};"></span> Entraineur de club
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background:${levelColors.ASSIST};"></span> Assistant Entraineur
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background:${levelColors.NOC};"></span> Sans entraîneur
            </div>
        `;
        return div;
    };
    legend.addTo(map);
}

// --------------------------------------------------
// Init
// --------------------------------------------------
async function init() {
    // 1) Clubs + GPS
    const gpsLines = await loadCSV("liste ville gps.csv");
    const clubs = {};
    for (let i = 1; i < gpsLines.length; i++) {
        const p = gpsLines[i].split(";");
        if (p.length < 5) continue;

        const code     = p[0].trim();
        const nom      = cleanText(p[1].trim());
        const nomCourt = cleanText(p[2].trim());
        const latLike  = p[3].trim();
        const lonLike  = p[4].trim();

        const coords = parseLatLon(latLike, lonLike);
        if (!coords) continue;

        const departement = inferDepartement(code);

        clubs[code] = {
            code,
            nom,
            nomCourt,
            lat: coords.lat,
            lon: coords.lon,
            departement,
            coachs: [],
            diplomes: [],
            level: null
        };
    }

    // 2) Entraîneurs
    const coachLines = await loadCSV("liste entraineur.csv");
    for (let i = 1; i < coachLines.length; i++) {
        const p = coachLines[i].split(";");
        if (p.length < 6) continue;

        const nom      = cleanText(p[2].trim());
        const prenom   = cleanText(p[3].trim());
        const diplRaw  = cleanDiplome(p[4]);
        const clubCode = p[5].trim();

        const club = clubs[clubCode];
        if (!club) continue;

        club.coachs.push({ nom, prenom, diplome: diplRaw });
        if (diplRaw && !club.diplomes.includes(diplRaw)) {
            club.diplomes.push(diplRaw);
        }
    }

    // 3) Niveau max + markers
    const deptSet = new Set();
    for (const club of Object.values(clubs)) {
        club.level = computeClubLevel(club);
        deptSet.add(club.departement);

        const marker = createCircleMarker(club.lat, club.lon, club.level.key);
        marker.bindPopup(buildPopupHtml(club));
        marker.addTo(map);
        markers.push({ marker, club });
    }

    // 4) Remplir filtre département
    Array.from(deptSet).sort().forEach(dept => {
        const opt = document.createElement("option");
        opt.value = dept;
        opt.textContent = dept;
        filterDept.appendChild(opt);
    });

    // 5) Légende
    addLegend();

    // 6) Filtres
    searchInput.addEventListener("input", applyFilters);
    filterDept.addEventListener("change", applyFilters);
    filterDiplome.addEventListener("change", applyFilters);
    btnReset.addEventListener("click", () => {
        searchInput.value = "";
        filterDept.value = "";
        filterDiplome.value = "";
        applyFilters();
    });
}

init();
</script>

</body>
</html>
